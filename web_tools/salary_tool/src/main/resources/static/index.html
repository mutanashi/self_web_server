<!doctype html>
<html lang="en">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>Salary System</title>
      <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3EðŸ’¼%3C/text%3E%3C/svg%3E">
      <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
      header { display: flex; gap: 1rem; align-items: baseline; }
      h1 { margin: 0; font-size: 1.5rem; }
      small { color: #666; }
      section { margin-top: 1.5rem; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
      section h2 { margin: 0 0 0.5rem; font-size: 1.1rem; }
      form { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
      input, button, select, textarea { padding: 0.4rem 0.6rem; font-size: 0.95rem; }
      code { background: #f6f8fa; padding: 0.2rem 0.4rem; border-radius: 4px; }
      .row { display: flex; gap: 0.5rem; align-items: center; }
      .ok { color: #0a7f2e; }
      .err { color: #b00020; }
      pre { white-space: pre-wrap; background: #fafafa; padding: 0.75rem; border-radius: 6px; border: 1px solid #eee; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
    </style>
  </head>
  <body>
    <header>
      <h1>Salary System</h1>
      <small>Backend API demo UI</small>
      <span style="margin-left:auto"></span>
      <div>JWT: <code id="jwt-short">(none)</code></div>
      <button id="btn-logout" style="display:none">Logout</button>
    </header>

    <section>
      <h2>Environment</h2>
      <div class="row">
        <label>Base URL:</label>
        <input id="base-url" value="" size="40" placeholder="default: same origin" />
        <button id="btn-save-base">Save</button>
      </div>
      <small>Leave empty to use same origin (recommended when served by Spring).</small>
    </section>

    <div class="grid">
      <section>
        <h2>Register</h2>
        <form id="form-register">
          <input id="reg-username" placeholder="username" required />
          <input id="reg-email" type="email" placeholder="email" required />
          <input id="reg-pass" type="password" placeholder="password" required />
          <button type="submit">Register</button>
        </form>
        <small>Check DB for verification token, then verify below.</small>
        <pre id="out-register"></pre>
      </section>

      <section>
        <h2>Verify Email</h2>
        <form id="form-verify">
          <input id="ver-token" placeholder="paste verification token" required />
          <button type="submit">Verify</button>
        </form>
        <pre id="out-verify"></pre>
      </section>

      <section>
        <h2>Login</h2>
        <form id="form-login">
          <input id="login-email" type="email" placeholder="email" required />
          <input id="login-pass" type="password" placeholder="password" required />
          <button type="submit">Login</button>
        </form>
        <pre id="out-login"></pre>
      </section>
    </div>

    <div class="grid">
      <section>
        <h2>Employee: Public Items</h2>
        <button id="btn-list-public">List Public Items</button>
        <pre id="out-public"></pre>
      </section>

      <section>
        <h2>Employee: Clock-in</h2>
        <button id="btn-clock-in">Clock In (now)</button>
        <pre id="out-clock"></pre>
      </section>

      <section>
        <h2>Employee: Email Me</h2>
        <form id="form-email-me">
          <input id="em-subject" placeholder="subject (optional)" size="28" />
          <textarea id="em-body" placeholder="message body (optional)" rows="2" cols="30"></textarea>
          <button type="submit">Send email</button>
        </form>
        <small>Sends an email to your account email.</small>
        <pre id="out-email-me"></pre>
      </section>

      <section>
        <h2>Employee: Salaries</h2>
        <form id="form-salary">
          <input id="sal-year" type="number" placeholder="year (e.g. 2025)" />
          <input id="sal-month" type="number" placeholder="month (1-12)" />
          <button type="submit">Fetch</button>
        </form>
        <pre id="out-salary"></pre>
      </section>

      <section>
        <h2>Employee: Attendances</h2>
        <form id="form-att">
          <input id="att-start" type="date" />
          <input id="att-end" type="date" />
          <button type="submit">Fetch</button>
        </form>
        <pre id="out-att"></pre>
      </section>
    </div>

    <div class="grid">
      <section>
        <h2>Boss: Create Employee</h2>
        <form id="form-ce">
          <input id="ce-username" placeholder="username" required />
          <input id="ce-email" type="email" placeholder="employee email" required />
          <input id="ce-pass" type="text" placeholder="temp password" required />
          <input id="ce-labels" type="text" placeholder='labels comma-separated (e.g. A,B)' />
          <button type="submit">Create</button>
        </form>
        <pre id="out-ce"></pre>
      </section>

      <section>
        <h2>Boss: Create Public Item</h2>
        <form id="form-pi">
          <input id="pi-title" placeholder="title" required />
          <textarea id="pi-content" placeholder="content" rows="3" required></textarea>
          <button type="submit">Create</button>
        </form>
        <pre id="out-pi"></pre>
      </section>

      <section>
        <h2>Boss: Export Employees</h2>
        <form id="form-export">
          <input id="ex-labels" type="text" placeholder='filter labels (A,B) optional' />
          <input id="ex-year" type="number" placeholder="year optional" />
          <input id="ex-month" type="number" placeholder="month optional" />
          <button type="submit">Export</button>
        </form>
        <small>Returns a file path under server-side <code>exports/</code>.</small>
        <pre id="out-export"></pre>
      </section>
    </div>

    <section>
      <h2>Raw Response</h2>
      <pre id="out-raw">Ready.</pre>
    </section>

    <script>
      const $ = (id) => document.getElementById(id);
      const out = (el, text, ok=true) => { el.textContent = typeof text === 'string' ? text : JSON.stringify(text, null, 2); el.className = ok ? 'ok' : 'err'; $('out-raw').textContent = el.textContent; };

      // Auto-detect base URL when running behind proxy
      const detectBaseUrl = () => {
        const path = window.location.pathname;
        if (path.includes('/web_tools/salary_tool/')) {
          return '/web_tools/salary_tool';
        }
        return '';
      };

      const state = {
        base: localStorage.getItem('base') || detectBaseUrl(),
        token: localStorage.getItem('jwt') || ''
      };

      const baseInput = $('base-url');
      baseInput.value = state.base;

      const jwtShort = $('jwt-short');
      const updateJwtUi = () => {
        if (state.token) {
          jwtShort.textContent = state.token.slice(0, 12) + 'â€¦';
          $('btn-logout').style.display = '';
        } else {
          jwtShort.textContent = '(none)';
          $('btn-logout').style.display = 'none';
        }
      };
      updateJwtUi();

      $('btn-save-base').onclick = () => {
        state.base = baseInput.value.trim();
        localStorage.setItem('base', state.base);
        out($('out-raw'), 'Saved base: ' + (state.base || '(same origin)'));
      };
      $('btn-logout').onclick = () => {
        state.token = '';
        localStorage.removeItem('jwt');
        updateJwtUi();
        out($('out-raw'), 'Logged out');
      };

      const url = (p) => (state.base ? state.base.replace(/\/$/, '') : '') + p;
      const headers = () => {
        const h = { 'Content-Type': 'application/json' };
        if (state.token) h['Authorization'] = 'Bearer ' + state.token;
        return h;
      };
      async function call(endpoint, opts={}) {
        const res = await fetch(url(endpoint), opts);
        let bodyText = await res.text();
        let body;
        try { body = bodyText ? JSON.parse(bodyText) : null; } catch { body = bodyText; }
        return { status: res.status, ok: res.ok, body };
      }

      // Register
      $('form-register').onsubmit = async (e) => {
        e.preventDefault();
        const username = $('reg-username').value.trim();
        const email = $('reg-email').value.trim();
        const password = $('reg-pass').value;
        const resp = await call('/api/auth/register', { method: 'POST', headers: headers(), body: JSON.stringify({ username, email, password }) });
        out($('out-register'), resp, resp.ok);
      };

      // Verify
      $('form-verify').onsubmit = async (e) => {
        e.preventDefault();
        const token = encodeURIComponent($('ver-token').value.trim());
        const resp = await call('/api/auth/verify?token=' + token, { method: 'GET', headers: headers() });
        out($('out-verify'), resp, resp.ok);
      };

      // Login
      $('form-login').onsubmit = async (e) => {
        e.preventDefault();
        const email = $('login-email').value.trim();
        const password = $('login-pass').value;
        const resp = await call('/api/auth/login', { method: 'POST', headers: headers(), body: JSON.stringify({ email, password }) });
        out($('out-login'), resp, resp.ok);
        if (resp.ok && resp.body && resp.body.token) {
          state.token = resp.body.token;
          localStorage.setItem('jwt', state.token);
          updateJwtUi();
        }
      };

      // Employee
      $('btn-list-public').onclick = async () => {
        const resp = await call('/api/employee/public-items', { headers: headers() });
        out($('out-public'), resp, resp.ok);
      };
      $('btn-clock-in').onclick = async () => {
        const resp = await call('/api/employee/clock-in', { method: 'POST', headers: headers() });
        out($('out-clock'), resp, resp.ok);
      };
      $('form-email-me').onsubmit = async (e) => {
        e.preventDefault();
        const subject = $('em-subject').value.trim();
        const body = $('em-body').value.trim();
        const payload = {};
        if (subject) payload.subject = subject;
        if (body) payload.body = body;
        const resp = await call('/api/employee/email-me', {
          method: 'POST',
          headers: headers(),
          body: JSON.stringify(payload)
        });
        out($('out-email-me'), resp, resp.ok);
      };
      $('form-salary').onsubmit = async (e) => {
        e.preventDefault();
        const year = $('sal-year').value.trim();
        const month = $('sal-month').value.trim();
        const q = new URLSearchParams();
        if (year) q.set('year', year);
        if (month) q.set('month', month);
        const resp = await call('/api/employee/salaries' + (q.toString() ? '?' + q.toString() : ''), { headers: headers() });
        out($('out-salary'), resp, resp.ok);
      };
      $('form-att').onsubmit = async (e) => {
        e.preventDefault();
        const start = $('att-start').value;
        const end = $('att-end').value;
        const q = new URLSearchParams();
        if (start) q.set('start', start);
        if (end) q.set('end', end);
        const resp = await call('/api/employee/attendances' + (q.toString() ? '?' + q.toString() : ''), { headers: headers() });
        out($('out-att'), resp, resp.ok);
      };

      // Boss
      $('form-ce').onsubmit = async (e) => {
        e.preventDefault();
        const username = $('ce-username').value.trim();
        const email = $('ce-email').value.trim();
        const password = $('ce-pass').value.trim();
        const labelsRaw = $('ce-labels').value.trim();
        const labels = labelsRaw ? labelsRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
        const body = { username, email, password };
        if (labels.length) body.labels = labels;
        const resp = await call('/api/boss/employees', { method: 'POST', headers: headers(), body: JSON.stringify(body) });
        out($('out-ce'), resp, resp.ok);
      };
      $('form-pi').onsubmit = async (e) => {
        e.preventDefault();
        const title = $('pi-title').value.trim();
        const content = $('pi-content').value.trim();
        const resp = await call('/api/boss/public-items', { method: 'POST', headers: headers(), body: JSON.stringify({ title, content }) });
        out($('out-pi'), resp, resp.ok);
      };
      $('form-export').onsubmit = async (e) => {
        e.preventDefault();
        const labelsRaw = $('ex-labels').value.trim();
        const labels = labelsRaw ? labelsRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
        const year = $('ex-year').value.trim();
        const month = $('ex-month').value.trim();
        const body = {};
        if (labels.length) body.labelNames = labels;
        if (year) body.year = Number(year);
        if (month) body.month = Number(month);
        const resp = await call('/api/boss/export', { method: 'POST', headers: headers(), body: JSON.stringify(body) });
        out($('out-export'), resp, resp.ok);
      };
    </script>
  </body>
  </html>
